<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GST & Pricing Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@700;800&display=swap"
      rel="stylesheet"
    />
    <!-- Updated Chart.js libraries with proper versions -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.umd.js"></script>

    <style>
      :root {
        /* Vibrant Primary Colors - Teal/Emerald Gradient */
        --primary: #10b981;
        --primary-dark: #059669;
        --primary-light: #34d399;
        --secondary: #8b5cf6;
        --accent: #f59e0b;

        /* Background Gradients */
        --bg-gradient-start: #f0fdf4;
        --bg-gradient-end: #dbeafe;
        --card-bg: rgba(255, 255, 255, 0.95);

        /* Text Colors */
        --text-primary: #1f2937;
        --main-heading-color: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;

        /* UI Elements */
        --border-color: #e5e7eb;
        --input-bg: #ffffff;
        --result-bg: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --heading-color: #8b5cf6;
        --success-bg: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        --success-text: #ffffff;

        /* Glassmorphism */
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(255, 255, 255, 0.18);

        /* Shadows */
        --shadow-sm: 0 4px 6px -1px rgba(16, 185, 129, 0.1);
        --shadow-md: 0 10px 25px -5px rgba(16, 185, 129, 0.2);
        --shadow-lg: 0 20px 50px -12px rgba(16, 185, 129, 0.3);
        --shadow-glow: 0 0 30px rgba(16, 185, 129, 0.4);
      }

      body.dark-mode {
        /* Dark Mode - Vibrant Purple/Blue Theme */
        --primary: #8b5cf6;
        --primary-dark: #7c3aed;
        --primary-light: #a78bfa;
        --secondary: #10b981;
        --accent: #f59e0b;

        /* Dark Backgrounds with Gradient */
        --bg-gradient-start: #0f172a;
        --bg-gradient-end: #1e1b4b;
        --card-bg: rgba(30, 27, 75, 0.8);

        /* Dark Text Colors */
        --text-primary: #f1f5f9;
        --main-heading-color: linear-gradient(135deg, #8b5cf6 0%, #10b981 100%);
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;

        /* Dark UI Elements */
        --border-color: #334155;
        --input-bg: rgba(51, 65, 85, 0.5);
        --success-bg: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        --heading-color: #10b981;

        /* Dark Glassmorphism */
        --glass-bg: rgba(30, 27, 75, 0.6);
        --glass-border: rgba(139, 92, 246, 0.2);

        /* Dark Shadows with Glow */
        --shadow-sm: 0 4px 6px -1px rgba(139, 92, 246, 0.2);
        --shadow-md: 0 10px 25px -5px rgba(139, 92, 246, 0.3);
        --shadow-lg: 0 20px 50px -12px rgba(139, 92, 246, 0.4);
        --shadow-glow: 0 0 40px rgba(139, 92, 246, 0.5);
      }

      body.dark-mode button.secondary {
        background: transparent;
        color: var(--primary);
        border-color: var(--primary);
      }

      body.dark-mode button.secondary:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
      }

      body.dark-mode footer {
        color: var(--primary);
      }

      .dark-mode input[type="number"]:focus,
      .dark-mode input[type="text"]:focus {
        background: rgba(51, 65, 85, 0.7);
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2),
          0 4px 12px rgba(139, 92, 246, 0.3);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Lato", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          var(--bg-gradient-start) 0%,
          var(--bg-gradient-end) 100%
        );
        background-attachment: fixed;
        color: var(--text-primary);
        margin: 0;
        padding: 32px 24px;
        min-height: 100vh;
      }

      .wrap {
        max-width: 1280px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 32px;
        animation: fadeInDown 0.6s ease-out;
      }

      h1 {
        margin: 0 0 8px 0;
        font-size: 32px;
        font-weight: 700;
        font-family: "Montserrat", sans-serif;
        background: var(--main-heading-color);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.5px;
        filter: drop-shadow(0 2px 8px rgba(16, 185, 129, 0.3));
      }

      .subtitle {
        color: var(--text-secondary);
        font-size: 16px;
        font-weight: 400;
      }

      .theme-toggle-btn {
        position: absolute;
        top: 24px;
        right: 24px;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 2px solid var(--glass-border);
        color: var(--text-secondary);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-sm);
      }

      .theme-toggle-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-2px) scale(1.1) rotate(15deg);
        box-shadow: var(--shadow-md), var(--shadow-glow);
      }

      .dark-mode .theme-toggle-btn:hover {
        box-shadow: var(--shadow-md), 0 0 30px rgba(139, 92, 246, 0.4);
      }

      .card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid var(--glass-border);
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(16, 185, 129, 0.1);
        padding: 18px;
        animation: fadeInUp 0.6s ease-out;
        position: relative;
        overflow: hidden;
      }

      .main-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        align-items: baseline;
      }

      .left-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .right-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
        position: sticky;
        top: 1px;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(
          90deg,
          #10b981 0%,
          #3b82f6 50%,
          #8b5cf6 100%
        );
        box-shadow: 0 2px 10px rgba(16, 185, 129, 0.5);
      }

      .main-section-title {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
        margin: 0 0 24px 0;
        min-height: 54px;
        font-family: "Montserrat", sans-serif;
        line-height: 1.2;
      }

      .section-title {
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: baseline;
        gap: 12px;
        min-height: 54px;
        font-family: "Montserrat", sans-serif;
        /* Enhanced alignment properties */
        text-align: left;
        line-height: 1.2;
        position: relative;
      }

      .section-title::before {
        content: "";
        font-size: 22px;
        width: 28px;
        display: inline-block;
        flex-shrink: 0;
      }

      .left-section .section-title {
        color: var(--primary) !important;
      }

      .right-section .section-title {
        color: var(--secondary) !important;
      }

      .right-section .section-title::before {
        content: "";
      }

      /* Ensure both sections have the same height and alignment */
      .left-section,
      .right-section {
        height: auto;
        align-self: start;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .input-group {
        position: relative;
      }

      label {
        display: block;
        font-size: 13px;
        font-weight: 700;
        color: var(--text-secondary);
        margin-bottom: 8px;
        transition: color 0.2s;
      }

      input[type="number"],
      input[type="text"] {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        font-size: 15px;
        background: var(--input-bg);
        color: var(--text-primary);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 400;
        box-shadow: var(--shadow-sm);
      }

      input[type="number"]:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--card-bg);
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15),
          0 4px 12px rgba(16, 185, 129, 0.2);
        transform: translateY(-2px);
      }

      input[type="number"]:hover,
      input[type="text"]:hover {
        border-color: var(--primary-light);
        box-shadow: var(--shadow-md);
      }

      .results {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .result-box {
        background: linear-gradient(
          135deg,
          var(--glass-bg) 0%,
          rgba(255, 255, 255, 0.5) 100%
        );
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 16px;
        border: 2px solid var(--border-color);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
      }

      .result-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #10b981 0%, #3b82f6 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .result-box:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: var(--shadow-md), var(--shadow-glow);
        border-color: var(--primary);
      }

      .result-box:hover::before {
        opacity: 1;
      }

      .result-label {
        color: var(--text-muted);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .result-value {
        font-weight: 700;
        font-size: 22px;
        color: var(--text-primary);
        font-family: "Montserrat", sans-serif;
      }

      .result-box.final {
        background: #8fbc8f;
        color: black;
        border: none;
        padding: 24px;
        transform: scale(1.02);
        box-shadow: 0 10px 30px rgba(143, 188, 143, 0.4),
          0 0 40px rgba(143, 188, 143, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .result-box.final .result-label {
        color: rgba(0, 0, 0, 0.7);
        font-size: 13px;
      }

      .result-box.final .result-value {
        color: black;
        font-size: 32px;
        font-weight: 800;
        font-family: "Montserrat", sans-serif;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
      }

      .result-box.final::before {
        display: none;
      }

      .result-box.final:hover {
        transform: scale(1.06) translateY(-4px);
        box-shadow: 0 15px 40px rgba(143, 188, 143, 0.5),
          0 0 60px rgba(143, 188, 143, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 28px;
        padding-top: 28px;
        border-top: 2px solid var(--border-color);
      }

      button {
        background: transparent;
        color: var(--primary);
        padding: 12px 24px;
        border-radius: 12px;
        border: 2px solid var(--primary);
        cursor: pointer;
        font-weight: 700;
        font-size: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: none;
        position: relative;
        overflow: hidden;
      }

      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      button:hover::before {
        left: 100%;
      }

      button:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px) scale(1.02);
        box-shadow: var(--shadow-md);
      }

      button:active {
        transform: translateY(0) scale(0.98);
        box-shadow: var(--shadow-sm);
        background: var(--primary-dark);
        color: white;
      }

      button.secondary {
        background: transparent;
        color: var(--primary);
        border: 2px solid var(--primary);
        box-shadow: none;
      }

      button.secondary:hover {
        background: var(--primary);
        color: white;
        border-color: transparent;
        box-shadow: var(--shadow-sm);
      }

      button.small {
        font-size: 13px;
        padding: 10px 18px;
      }

      .formula-section {
        margin-top: 32px;
        padding: 20px 24px;
        background: var(--input-bg);
        border-radius: 16px;
        border: 2px solid var(--border-color);
      }

      .dark-mode .formula-section {
        background: var(--input-bg);
        border-color: var(--border-color);
        color: var(--text-secondary);
      }

      .formula-section .section-title {
        color: var(--text-primary);
        margin-bottom: 16px;
      }

      .formula-section .section-title::before {
        content: "üí°";
      }

      .dark-mode .formula-section .section-title {
        color: var(--text-primary);
      }

      .formula-section ul {
        margin: 0;
        padding-left: 20px;
        color: #78350f;
      }

      .dark-mode .formula-section ul {
        color: var(--text-secondary);
      }

      .formula-section li {
        margin-bottom: 8px;
        font-size: 14px;
        line-height: 1.6;
      }

      /* FIXED: Chart container styles to prevent infinite scrolling */
      #chart-card {
        margin-top: 32px;
      }

      #chart-card .section-title {
        margin-bottom: 20px;
      }

      #cost-breakdown-chart {
        max-height: 350px !important;
        width: 100% !important;
        height: auto !important;
      }

      /* Ensure chart canvas has proper constraints */
      .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
        overflow: hidden;
      }

      footer {
        margin-top: 24px;
        text-align: center;
        font-size: 14px;
        color: var(--text-secondary);
        padding: 16px;
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        box-shadow: var(--shadow-sm);
        animation: fadeInUp 0.6s ease-out 0.2s both;
      }

      footer strong {
        color: var(--primary);
        font-weight: 700;
      }

      @keyframes fadeInDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 900px) {
        body {
          padding: 20px 16px;
        }

        h1 {
          font-size: 24px;
        }

        .card {
          padding: 24px 20px;
          border-radius: 20px;
        }

        .main-layout {
          grid-template-columns: 1fr;
          gap: 24px;
        }

        .right-section {
          position: static;
        }

        .theme-toggle-btn {
          top: 16px;
          right: 16px;
        }

        .actions {
          flex-direction: column;
        }

        button {
          width: 100%;
        }

        /* Mobile responsive chart */
        #chart-card {
          min-height: 350px;
          max-height: 400px;
        }

        #cost-breakdown-chart {
          max-height: 300px !important;
        }

        .chart-container {
          height: 300px;
        }
      }

      #final-price-breakdown {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 2px solid var(--border-color);
      }

      #final-price-breakdown table {
        width: 100%;
        font-size: 14px;
        border-collapse: collapse;
      }

      #final-price-breakdown td {
        padding: 6px 4px;
        font-family: "Courier New", Courier, monospace;
      }
      #final-price-breakdown td:last-child {
        text-align: right;
      }

      /* Custom Legend Styles */
      .custom-legend {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .legend-item {
        background: var(--input-bg);
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: transform 0.2s;
      }

      .legend-item:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
      }

      .legend-header {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        font-weight: 700;
        color: #374151; /* Explicit dark gray for light mode */
      }

      .dark-mode .legend-header {
        color: #e5e7eb;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .legend-details {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 14px;
      }

      .legend-value {
        font-weight: 700;
        font-family: "Montserrat", sans-serif;
        color: #111827; /* Explicit almost black for light mode */
      }

      .dark-mode .legend-value {
        color: #f3f4f6;
      }

      .legend-percent {
        font-size: 12px;
        color: var(--text-secondary);
        background: var(--card-bg);
        padding: 2px 8px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
      }

      .progress-bar {
        height: 6px;
        background: var(--border-color);
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease-out;
      }

      @media print {
        body {
          padding: 0;
          background: #fff !important;
          color: #000 !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        .wrap {
          max-width: 100%;
          margin: 0;
        }

        header,
        .theme-toggle-btn,
        .actions,
        footer {
          display: none !important;
        }

        .card,
        .result-box,
        .formula-section {
          box-shadow: none !important;
          border: 1px solid #ccc;
          border-radius: 0;
        }

        .right-section {
          position: static;
        }
      }
    </style>
    <style>
      .optimizer-button {
        display: block;
        width: 100%;
        background: #8fbc8f;
        color: black;
        padding: 20px 24px;
        border-radius: 16px;
        text-align: center;
        font-weight: 700;
        font-size: 20px;
        font-family: "Montserrat", sans-serif;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(143, 188, 143, 0.3);
      }
      .optimizer-button:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 12px 30px rgba(143, 188, 143, 0.4);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Amazon GST & Pricing Calculator</h1>
        <div class="subtitle">
          Calculate your product pricing with GST accurately
        </div>

        <button
          id="theme-toggle"
          class="theme-toggle-btn"
          title="Toggle dark mode"
        >
          üåô
        </button>
      </header>

      <div class="card">
        <div class="main-layout">
          <div class="left-section">
            <div class="main-section-title" style="color: var(--heading-color)">
              Product Information:
            </div>

            <div class="grid" role="form">
              <div class="input-group">
                <label>Product name</label>
                <input id="product" type="text" value="Cane Jaggery Powder" />
              </div>
              <div class="input-group">
                <label>Unit (for display)</label>
                <input id="unit" type="text" value="per kg" />
              </div>

              <div class="input-group">
                <label>Purchase cost (‚Çπ)</label>
                <input id="purchase" type="number" step="0.1" value="50" />
              </div>

              <div class="input-group">
                <label>Shipping cost (‚Çπ)</label>
                <input id="shipping" type="number" step="0.1" value="100" />
              </div>

              <div class="input-group">
                <label>Amazon referral fee (‚Çπ)</label>
                <input id="referral" type="number" step="0.1" value="7.08" />
              </div>

              <div class="input-group">
                <label>Packaging cost (‚Çπ)</label>
                <input id="packaging" type="number" step="0.1" value="20" />
              </div>

              <div class="input-group">
                <label>Margin % (on Selling Price before GST)</label>
                <input id="margin" type="number" step="0.1" value="15" />
              </div>

              <div class="input-group">
                <label>GST rate % (applied on selling price before GST)</label>
                <input id="gstrate" type="number" step="0.1" value="5" />
              </div>
            </div>

            <div class="actions">
              <button id="calc">‚ú® Calculate</button>
              <button id="reset" class="secondary small">
                üîÑ Reset defaults
              </button>
              <button id="copy" class="secondary small">
                üìã Copy final price
              </button>
              <button id="share" class="secondary small">üîó Share</button>
              <button id="export" class="secondary small">üíæ Export CSV</button>
              <button id="copy-results" class="secondary small">
                üìã Copy Results
              </button>
              <button id="print" class="secondary small">üñ®Ô∏è Print</button>
            </div>

            <div class="formula-section">
              <div class="section-title">Calculation Formulas</div>
              <ul>
                <li>
                  <strong>Total cost</strong> = Purchase + Shipping + Referral +
                  Packaging
                </li>
                <li>
                  <strong>Selling price before GST</strong> = Total cost / (1 -
                  (Margin % / 100))
                </li>
                <li>
                  <strong>Profit</strong> = Selling price before GST - Total
                  cost
                </li>
                <li>
                  <strong>GST amount</strong> = Selling price before GST √ó (GST
                  % / 100)
                </li>
                <li>
                  <strong>Final selling price</strong> = Selling price before
                  GST + GST amount
                </li>
              </ul>
            </div>

            <div style="margin-top: 24px">
              <a
                href="pricing-optimizer.html"
                class="optimizer-button"
                target="_blank"
                rel="noopener noreferrer"
              >
                Pricing Optimizer</a
              >
            </div>
          </div>

          <div class="right-section">
            <div class="main-section-title" style="color: var(--heading-color)">
              Calculation Results:
            </div>

            <div class="results">
              <div class="result-box">
                <div class="result-label">Total cost (excl. GST)</div>
                <div id="totalCost" class="result-value">‚Çπ 0.00</div>
              </div>

              <div class="result-box">
                <div class="result-label">Profit (‚Çπ)</div>
                <div id="profit" class="result-value">‚Çπ 0.00</div>
              </div>

              <div class="result-box">
                <div class="result-label">Selling price before GST</div>
                <div id="sellBefore" class="result-value">‚Çπ 0.00</div>
              </div>

              <div class="result-box">
                <div class="result-label">GST amount (‚Çπ)</div>
                <div id="gstAmt" class="result-value">‚Çπ 0.00</div>
              </div>

              <div class="result-box final">
                <div class="result-label">
                  üéØ Final selling price (including GST)
                </div>
                <div id="finalPrice" class="result-value">‚Çπ 0.00</div>
              </div>
            </div>

            <!-- FIXED: Added chart container with proper constraints -->
            <div class="card" id="chart-card">
              <div class="section-title">üìä Cost Breakdown</div>
              <div class="chart-container">
                <canvas id="cost-breakdown-chart"></canvas>
              </div>
              <!-- Custom Legend Container -->
              <div id="chart-custom-legend" class="custom-legend"></div>
              <div id="final-price-breakdown">
                <!-- Calculation breakdown will be injected here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        üí° <strong>Tip:</strong> Margin is calculated on
        <strong>Selling price before GST</strong>. GST is applied on the selling
        price before GST.
      </footer>
    </div>

    <script>
      const themeToggle = document.getElementById("theme-toggle");
      const body = document.body;

      function applyTheme(theme) {
        if (theme === "dark") {
          body.classList.add("dark-mode");
          themeToggle.innerText = "‚òÄÔ∏è";
          themeToggle.title = "Switch to light mode";
        } else {
          body.classList.remove("dark-mode");
          themeToggle.innerText = "üåô";
          themeToggle.title = "Switch to dark mode";
        }

        // Update chart if it exists to apply new theme colors
        if (typeof costChart !== "undefined" && costChart) {
          calculate();
        }
      }

      themeToggle.addEventListener("click", () => {
        const isDarkMode = body.classList.contains("dark-mode");
        const newTheme = isDarkMode ? "light" : "dark";
        localStorage.setItem("theme", newTheme);
        applyTheme(newTheme);
      });

      // On page load, apply the saved theme or system preference
      window.addEventListener("DOMContentLoaded", () => {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        const theme = savedTheme || (prefersDark ? "dark" : "light");
        applyTheme(theme);
      });

      let previousResults = {
        totalCost: 0,
        profit: 0,
        sellingBeforeGST: 0,
        gstAmt: 0,
        finalPrice: 0,
      };
      let costChart = null;

      // FIXED: Proper Chart.js initialization with error handling
      function initializeChart() {
        try {
          // Check if Chart.js is loaded
          if (typeof Chart === "undefined") {
            console.error("Chart.js library not loaded");
            return false;
          }

          // Register plugins if available
          if (typeof ChartDataLabels !== "undefined") {
            Chart.register(ChartDataLabels);
          }
          return true;
        } catch (error) {
          console.error("Error initializing chart:", error);
          return false;
        }
      }

      function fmt(n) {
        return isFinite(n) ? Number(n).toFixed(2) : "0.00";
      }

      function calculate() {
        const purchase =
          parseFloat(document.getElementById("purchase").value) || 0;
        const shipping =
          parseFloat(document.getElementById("shipping").value) || 0;
        const referral =
          parseFloat(document.getElementById("referral").value) || 0;
        const packaging =
          parseFloat(document.getElementById("packaging").value) || 0;
        const marginPct =
          parseFloat(document.getElementById("margin").value) || 0;
        const gstPct =
          parseFloat(document.getElementById("gstrate").value) || 0;

        const totalCost = purchase + shipping + referral + packaging;

        // Gross Margin Calculation:
        // Selling Price = Total Cost / (1 - Margin%)
        let sellingBeforeGST = 0;
        if (marginPct < 100) {
          sellingBeforeGST = totalCost / (1 - marginPct / 100);
        } else {
          // Prevent division by zero or negative price
          sellingBeforeGST = totalCost;
          alert("Margin cannot be 100% or more!");
        }

        const profit = sellingBeforeGST - totalCost;
        const gstAmt = sellingBeforeGST * (gstPct / 100);
        const finalPrice = sellingBeforeGST + gstAmt;

        animateValue(
          document.getElementById("totalCost"),
          previousResults.totalCost,
          totalCost,
          500
        );
        animateValue(
          document.getElementById("profit"),
          previousResults.profit,
          profit,
          500
        );
        animateValue(
          document.getElementById("sellBefore"),
          previousResults.sellingBeforeGST,
          sellingBeforeGST,
          500
        );
        animateValue(
          document.getElementById("gstAmt"),
          previousResults.gstAmt,
          gstAmt,
          500
        );
        animateValue(
          document.getElementById("finalPrice"),
          previousResults.finalPrice,
          finalPrice,
          500
        );

        previousResults = {
          totalCost,
          profit,
          sellingBeforeGST,
          gstAmt,
          finalPrice,
        };

        updateChart({
          ...previousResults,
          purchase,
          shipping,
          referral,
          packaging,
          profit,
          gstAmt,
        });

        updateBreakdownTable({
          ...previousResults,
          purchase,
          shipping,
          referral,
          packaging,
        });

        return {
          totalCost,
          profit,
          sellingBeforeGST,
          gstAmt,
          finalPrice,
          purchase,
          shipping,
          referral,
          packaging,
        };
      }

      function animateValue(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          const currentValue = progress * (end - start) + start;
          element.innerText = "‚Çπ " + fmt(currentValue);
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }

      function updateBreakdownTable(data) {
        const container = document.getElementById("final-price-breakdown");
        const {
          purchase,
          shipping,
          referral,
          packaging,
          profit,
          gstAmt,
          finalPrice,
        } = data;

        const content = `
          <table>
            <tr><td>Purchase Cost</td><td>‚Çπ ${fmt(purchase)}</td></tr>
            <tr><td>Shipping Cost</td><td>‚Çπ ${fmt(shipping)}</td></tr>
            <tr><td>Referral Fee</td><td>‚Çπ ${fmt(referral)}</td></tr>
            <tr><td>Packaging Cost</td><td>‚Çπ ${fmt(packaging)}</td></tr>
            <tr><td>Profit</td><td>‚Çπ ${fmt(profit)}</td></tr>
            <tr><td>GST Amount</td><td>‚Çπ ${fmt(gstAmt)}</td></tr>
            <tr>
              <td colspan="2" style="padding: 4px 0;">
                <hr style="border: none; border-top: 1px solid var(--border-color);">
              </td>
            </tr>
            <tr>
              <td style="font-weight: bold;">Final Selling Price</td>
              <td style="font-weight: bold;">‚Çπ ${fmt(finalPrice)}</td>
            </tr>
          </table>
        `;

        container.innerHTML = content;
      }

      function updateChart(data) {
        // FIXED: Check if chart library is available
        if (typeof Chart === "undefined") {
          console.warn("Chart.js not available, skipping chart update");
          return;
        }

        const ctx = document
          .getElementById("cost-breakdown-chart")
          .getContext("2d");
        const isDarkMode = document.body.classList.contains("dark-mode");
        const textColor = isDarkMode ? "#f5f5f5" : "#212121";

        const chartData = {
          labels: [
            "Purchase",
            "Shipping",
            "Referral",
            "Packaging",
            "Profit",
            "GST",
          ],
          datasets: [
            {
              label: "Cost Breakdown",
              data: [
                data.purchase,
                data.shipping,
                data.referral,
                data.packaging,
                data.profit,
                data.gstAmt,
              ],
              backgroundColor: [
                "#10b981", // Emerald - Purchase
                "#3b82f6", // Blue - Shipping
                "#8b5cf6", // Purple - Referral
                "#f59e0b", // Amber - Packaging
                "#ec4899", // Pink - Profit
                "#06b6d4", // Cyan - GST
              ],
              borderColor: isDarkMode ? "#1e1e1e" : "#ffffff",
              borderWidth: 2,
            },
          ],
        };

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false, // FIXED: Proper aspect ratio control
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                color: isDarkMode ? "#e5e7eb" : "#374151",
                font: {
                  family: "'Lato', sans-serif",
                  size: 12,
                  weight: "bold",
                },
                padding: 20,
                usePointStyle: true,
                pointStyle: "circle",
              },
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.label || "";
                  if (label) {
                    label += ": ";
                  }
                  if (context.parsed !== null) {
                    label += "‚Çπ " + fmt(context.parsed);
                  }
                  return label;
                },
              },
            },
            datalabels: {
              display: true,
              formatter: (value, ctx) => {
                const datapoints = ctx.chart.data.datasets[0].data;
                const total = datapoints.reduce(
                  (total, datapoint) => total + datapoint,
                  0
                );
                const percentage = (value / total) * 100;
                // Hide label if percentage is too small to avoid clutter
                if (percentage < 3) {
                  return "";
                }
                const label = ctx.chart.data.labels[ctx.dataIndex];
                return label + "\n" + percentage.toFixed(1) + "%";
              },
              color: "#fff",
              font: {
                weight: "bold",
                size: 12,
                lineHeight: 1.3,
              },
              textAlign: "center",
              anchor: "center",
              align: "center",
              offset: 0,
              borderRadius: 4,
              backgroundColor: "rgba(0, 0, 0, 0.7)",
              padding: 8,
              textStrokeColor: "#000",
              textStrokeWidth: 2,
            },
          },
          layout: {
            padding: {
              top: 10,
              bottom: 10,
            },
          },
          // FIXED: Prevent infinite canvas expansion
          animation: {
            duration: 750,
          },
        };

        try {
          // Destroy existing chart to ensure clean state and proper plugin loading
          if (costChart) {
            costChart.destroy();
          }

          // Create new chart
          const chartConfig = {
            type: "doughnut",
            data: chartData,
            options: chartOptions,
          };

          // Add datalabels plugin if available
          if (typeof ChartDataLabels !== "undefined") {
            // Disable default labels as we have custom legend now
            chartConfig.plugins = [ChartDataLabels];
            chartConfig.options.plugins.datalabels = { display: false };
          } else {
            console.warn("ChartDataLabels plugin not found");
          }

          costChart = new Chart(ctx, chartConfig);

          // Update custom legend
          updateCustomLegend(chartData);
        } catch (error) {
          console.error("Error updating chart:", error);
        }
      }

      function updateCustomLegend(data) {
        const container = document.getElementById("chart-custom-legend");
        if (!container) return;

        const labels = data.labels;
        const values = data.datasets[0].data;
        const colors = data.datasets[0].backgroundColor;
        const total = values.reduce((a, b) => a + b, 0);

        let html = "";

        labels.forEach((label, index) => {
          const value = values[index];
          const color = colors[index];
          const percentage =
            total > 0 ? ((value / total) * 100).toFixed(1) : "0.0";

          // Skip if value is 0
          if (value <= 0) return;

          html += `
            <div class="legend-item">
              <div class="legend-header">
                <div class="legend-color" style="background-color: ${color}"></div>
                <span>${label}</span>
              </div>
              <div class="legend-details">
                <span class="legend-value">‚Çπ ${fmt(value)}</span>
                <span class="legend-percent">${percentage}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%; background-color: ${color}"></div>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      function resetPreviousResults() {
        previousResults.totalCost = 0;
        previousResults.profit = 0;
        previousResults.sellingBeforeGST = 0;
        previousResults.gstAmt = 0;
        previousResults.finalPrice = 0;
      }

      document.getElementById("calc").addEventListener("click", function (e) {
        e.preventDefault();
        calculate();
      });

      document.getElementById("reset").addEventListener("click", function () {
        document.getElementById("product").value = "Cane Jaggery Powder";
        document.getElementById("unit").value = "per kg";
        document.getElementById("purchase").value = 50;
        document.getElementById("shipping").value = 100;
        document.getElementById("referral").value = 7.08;
        document.getElementById("packaging").value = 20;
        document.getElementById("margin").value = 20;
        document.getElementById("gstrate").value = 5;
        resetPreviousResults();
        calculate();
      });

      document
        .getElementById("copy")
        .addEventListener("click", async function () {
          const res = calculate();
          const text = `${document.getElementById("product").value} (${
            document.getElementById("unit").value
          }) - Final price: ‚Çπ ${fmt(res.finalPrice)}`;
          try {
            await navigator.clipboard.writeText(text);
            alert("‚úÖ Final price copied to clipboard!");
          } catch (e) {
            prompt("Copy this text", text);
          }
        });

      const shareButton = document.getElementById("share");
      if (navigator.share) {
        shareButton.addEventListener("click", async () => {
          const res = calculate();
          const text = `${document.getElementById("product").value} (${
            document.getElementById("unit").value
          }) - Final price: ‚Çπ ${fmt(res.finalPrice)}`;

          try {
            await navigator.share({
              title: "Amazon Pricing Calculation",
              text: text,
              url: window.location.href,
            });
          } catch (err) {
            console.error("Share failed:", err.message);
          }
        });
      } else {
        shareButton.style.display = "none";
      }

      document.getElementById("export").addEventListener("click", function () {
        const r = calculate();
        const rows = [
          [
            "Product",
            "Unit",
            "Purchase",
            "Shipping",
            "Referral",
            "Packaging",
            "TotalCost",
            "Margin%",
            "Profit",
            "SellingBeforeGST",
            "GST%",
            "GSTamt",
            "FinalPrice",
          ],
          [
            document.getElementById("product").value,
            document.getElementById("unit").value,
            fmt(r.purchase),
            fmt(r.shipping),
            fmt(r.referral),
            fmt(r.packaging),
            fmt(r.totalCost),
            document.getElementById("margin").value,
            fmt(r.profit),
            fmt(r.sellingBeforeGST),
            document.getElementById("gstrate").value,
            fmt(r.gstAmt),
            fmt(r.finalPrice),
          ],
        ];
        const csv = rows
          .map((r) =>
            r.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",")
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download =
          (document.getElementById("product").value || "pricing") + ".csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      document
        .getElementById("copy-results")
        .addEventListener("click", async function () {
          const r = calculate();
          const product = document.getElementById("product").value;
          const unit = document.getElementById("unit").value;
          const purchase = document.getElementById("purchase").value;
          const shipping = document.getElementById("shipping").value;
          const referral = document.getElementById("referral").value;
          const packaging = document.getElementById("packaging").value;
          const margin = document.getElementById("margin").value;
          const gstrate = document.getElementById("gstrate").value;

          const text = `
Product Information
-------------------
Product name:      ${product}
Unit:              ${unit}
Purchase cost:     ‚Çπ ${fmt(purchase)}
Shipping cost:     ‚Çπ ${fmt(shipping)}
Amazon referral:   ‚Çπ ${fmt(referral)}
Packaging cost:    ‚Çπ ${fmt(packaging)}
Margin:            ${margin}%
GST Rate:          ${gstrate}%

Calculation Results
-------------------
Total cost:        ‚Çπ ${fmt(r.totalCost)}
Profit:            ‚Çπ ${fmt(r.profit)}
Selling (pre-GST): ‚Çπ ${fmt(r.sellingBeforeGST)}
GST Amount:        ‚Çπ ${fmt(r.gstAmt)}
Final Price:       ‚Çπ ${fmt(r.finalPrice)}

Final Price Breakdown
---------------------
Purchase Cost:     ‚Çπ ${fmt(r.purchase)}
Shipping Cost:     ‚Çπ ${fmt(r.shipping)}
Referral Fee:      ‚Çπ ${fmt(r.referral)}
Packaging Cost:    ‚Çπ ${fmt(r.packaging)}
Profit:            ‚Çπ ${fmt(r.profit)}
GST Amount:        ‚Çπ ${fmt(r.gstAmt)}
---------------------------------
Final Selling Price: ‚Çπ ${fmt(r.finalPrice)}

Calculation Formulas
--------------------
Total cost = Purchase + Shipping + Referral + Packaging
Profit = Total cost √ó (Margin % / 100)
Selling price before GST = Total cost + Profit
GST amount = Selling price before GST √ó (GST % / 100)
Final selling price = Selling price before GST + GST amount
        `.trim();

          try {
            await navigator.clipboard.writeText(text);
            alert("‚úÖ Results copied to clipboard!");
          } catch (e) {
            prompt("Copy this text", text);
          }
        });

      document.getElementById("print").addEventListener("click", function () {
        // Use the browser's native print functionality on the whole page
        window.print();
      });

      // FIXED: Initialize chart with proper error handling
      window.addEventListener("DOMContentLoaded", () => {
        resetPreviousResults();

        // Initialize chart with error handling
        const chartInitialized = initializeChart();
        if (chartInitialized) {
          // Small delay to ensure DOM is fully ready
          setTimeout(() => {
            calculate();
          }, 100);
        }
      });
    </script>
  </body>
</html>
